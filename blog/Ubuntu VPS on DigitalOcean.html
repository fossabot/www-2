<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Setting up an Ubuntu VPS on DigitalOcean from scratch | Ricardo Balk</title>
    <meta name="description" content="Personal Website">
    
    
    <link rel="preload" href="/assets/css/0.styles.e5da866f.css" as="style"><link rel="preload" href="/assets/js/app.7b7c148d.js" as="script"><link rel="preload" href="/assets/js/3.a804b046.js" as="script"><link rel="preload" href="/assets/js/18.9517a86e.js" as="script"><link rel="prefetch" href="/assets/js/1.9bf74127.js"><link rel="prefetch" href="/assets/js/10.c32f9bd2.js"><link rel="prefetch" href="/assets/js/11.8d2a5515.js"><link rel="prefetch" href="/assets/js/12.89a78d15.js"><link rel="prefetch" href="/assets/js/13.8aee4667.js"><link rel="prefetch" href="/assets/js/14.38f99c55.js"><link rel="prefetch" href="/assets/js/15.099aee44.js"><link rel="prefetch" href="/assets/js/16.ee774475.js"><link rel="prefetch" href="/assets/js/17.0c79554d.js"><link rel="prefetch" href="/assets/js/19.48732743.js"><link rel="prefetch" href="/assets/js/20.aa4fdb9f.js"><link rel="prefetch" href="/assets/js/21.06396fdb.js"><link rel="prefetch" href="/assets/js/22.9ad4f847.js"><link rel="prefetch" href="/assets/js/23.59fa7903.js"><link rel="prefetch" href="/assets/js/24.3b58e86f.js"><link rel="prefetch" href="/assets/js/25.37fade1a.js"><link rel="prefetch" href="/assets/js/26.8f70353b.js"><link rel="prefetch" href="/assets/js/27.644eef78.js"><link rel="prefetch" href="/assets/js/28.c46c5b80.js"><link rel="prefetch" href="/assets/js/29.3ba82dac.js"><link rel="prefetch" href="/assets/js/30.1166d33a.js"><link rel="prefetch" href="/assets/js/31.735b5129.js"><link rel="prefetch" href="/assets/js/32.09614d65.js"><link rel="prefetch" href="/assets/js/33.0f10dfcf.js"><link rel="prefetch" href="/assets/js/4.65f9a52f.js"><link rel="prefetch" href="/assets/js/5.87a534d7.js"><link rel="prefetch" href="/assets/js/6.e254a224.js"><link rel="prefetch" href="/assets/js/7.c7cd18ca.js"><link rel="prefetch" href="/assets/js/8.1a2bc4b9.js"><link rel="prefetch" href="/assets/js/9.4c772792.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e5da866f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><header class="navbar"><a href="/" class="home-link router-link-active"><!----> <div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <span class="site-name can-hide">Ricardo Balk</span></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/portfolio/" class="nav-link">Portfolio</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Ubuntu VPS on DigitalOcean.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/nl/" class="nav-link">Nederlands</a></li></ul></div></div> <!----></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="theme-container no-sidebar"><header class="navbar"><a href="/" class="home-link router-link-active"><!----> <div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <span class="site-name can-hide">Ricardo Balk</span></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/portfolio/" class="nav-link">Portfolio</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Ubuntu VPS on DigitalOcean.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/nl/" class="nav-link">Nederlands</a></li></ul></div></div> <!----></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/portfolio/" class="nav-link">Portfolio</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Ubuntu VPS on DigitalOcean.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/nl/" class="nav-link">Nederlands</a></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <section tabindex="0" class="big-hero hasimage" style="--image:url(&quot;/assets/img/blog/ubuntu-on-digitalocean.png;--image-dark:url(&quot;/assets/img/blog/ubuntu-on-digitalocean.png&quot;);"><div class="grid-x valign-center"><div class="small-12 cell text-container text-center"><!----> <!----></div></div></section> <h1 class="page-title"><!---->Setting up an Ubuntu VPS on DigitalOcean from scratch</h1> <div class="theme-default-content content__default"><p>In this guide, you'll learn how to set up a VPS server from scratch on DigitalOcean's platform, which is equipped with Apache, HTTP/2 support, PHP 7.2, MariaDB, SSL certificates and ModSecurity (OWASP rules).</p> <p><span style="color:maroon;font-weight:bold;">Beware: This is a super comprehensive guide.</span></p> <p>A while ago, my bare-metal server died. After running a backup server on a Raspberry Pi, I decided to rent a VPS at DigitalOcean and migrate my old stuff there. Therefore, I wrote this tutorial both to help myself and others to set up a new Ubuntu VPS at DigitalOcean.</p> <p>Some steps in this tutorial could differ according to your particular preferences at DigitalOcean, e.g. when you are already familiar with SSH keys.</p> <h1 id="_1-create-a-new-droplet"><a href="#_1-create-a-new-droplet" class="header-anchor">#</a> 1 Create a new droplet</h1> <p>The first thing you should do is creating a new droplet on DigitalOcean. Choosing the latest LTS-release of Ubuntu Server is the best decision.</p> <blockquote><p>Note: LTS is the abbreviation of <strong>L</strong>ong <strong>T</strong>erm <strong>S</strong>upport, which means that the server software is maintained for a longer period of time and that (future) security issues will be resolved as well.</p></blockquote> <h1 id="_2-connect-for-the-first-time"><a href="#_2-connect-for-the-first-time" class="header-anchor">#</a> 2 Connect for the first time</h1> <p>After you created a new DigtalOcean droplet, connect to it using SSH. Windows users could use PuTTY for this, Linux and macOS-users should use the terminal.</p> <p>You'll be asked to change the root password upon your first login. Change the password to something secure and write it down.</p> <blockquote><p>Notes:</p> <ol><li>Don't make your life hard by choosing a password like <code>3uor2jofn2oi45r</code>. A secure password is actually called a pass<strong>phrase</strong> and consists of multiple, randomly chosen words. (e.g. <code>eastbound sibling banana survey</code>)</li> <li>If you already have added one or multiple public SSH key(s) to your account, you won't  be asked to change your password. Proceed to the next step.</li></ol></blockquote> <h1 id="_3-enhance-the-overall-server-security"><a href="#_3-enhance-the-overall-server-security" class="header-anchor">#</a> 3 Enhance the overall server security</h1> <p>To make your server more secure, it is advised to change a few default things.</p> <h2 id="hide-ssh-a-bit"><a href="#hide-ssh-a-bit" class="header-anchor">#</a> Hide SSH a bit</h2> <p>The default listening port for SSH is <code>22</code>. It is advised to change this, because it is a well known port that gets scanned by malicious parties, which will try to log in to your system.</p> <p>Edit the file <code>/etc/ssh/sshd_config</code>, e.g. by using nano: <code>nano /etc/ssh/sshd_config</code>.</p> <ul><li>In <code>/etc/sshd/sshd_config</code>, change the following lines:</li></ul> <div class="language- extra-class"><pre class="language-text"><code>Port 22
</code></pre></div><p>to something like</p> <div class="language- extra-class"><pre class="language-text"><code>Port 60022
</code></pre></div><blockquote><p>Note: Any port between 1023-65535 will work, as long as it is not in use by another application. Remember this port. Write it down somewhere.</p></blockquote> <ul><li><p>Save the configuration file (<code>Control-X</code> followed by <code>Y</code> if you're using <code>nano</code>).</p></li> <li><p>Restart the SSH daemon: <code>service sshd restart</code>.</p></li> <li><p>Open an extra terminal window and try to connect to your server, using the new port.</p> <blockquote><p>Note:</p> <p>Windows-users: Open a new PuTTY window.</p> <p>Linux and macOS users: <code>ssh root@&lt;server ip&gt; -p &lt;port number&gt;</code>.</p></blockquote></li></ul> <h2 id="use-public-key-authentication"><a href="#use-public-key-authentication" class="header-anchor">#</a> Use Public Key Authentication</h2> <p>Public Key Authentication is a well-known and secure way of authentication and is preferred for the following reasons:</p> <ol><li>It is easier than remembering a password. – You're only using a &quot;certificate file&quot; to authenticate and log in.</li> <li>You could create and use as many public keys as you want. – One for your computer at home, one for the computer at work, one for your notebook, one for your smart phone.</li> <li>Certificates are cryptographically more secure. – A computer guesses a 40 bit human made up password/-phrase within minutes, a 2048 bit certificate would take much more time.</li> <li>You could make keys unusable by removing a single line. – One of your devices got stolen? Remove the particular public key line from your droplet and all future access is denied.</li> <li>Easier sharing and collaboration. – If you want to give someone else access, add their public key. No password sharing, no password leaking.</li></ol> <p>Public key <em>pairs</em> always consist of two parts:</p> <ul><li>A private key — which you should keep for yourself and never share with someone else.</li> <li>A public key — which you could share.</li></ul> <h3 id="generating-new-ssh-key-pairs"><a href="#generating-new-ssh-key-pairs" class="header-anchor">#</a> Generating new SSH key pairs</h3> <p>The first step is to generate a public key pair to be used for authentication purposes.</p> <p><strong>Windows users</strong></p> <p>Windows users could use PuTTYgen to generate a new key pair.</p> <p><strong>Linux and macOS users</strong></p> <p>On Linux and macOS you could generate a new SSH key via terminal commands:</p> <ul><li>Use <code>ssh-keygen -t ed25519 -C 'Name of the new key'</code> to generate a new key pair. <code>ssh-keygen</code> saves the public key to <code>~/.ssh/id_ed25519.pub</code></li> <li>Execute <code>cat ~/.ssh/id_ed25519.pub</code>, it will show you your public key. Copy the output to the clipboard.</li></ul> <blockquote><p>Notes:</p> <ol><li><code>~/</code> is shorthand Unix (Linux/macOS) slang for the directory <code>/home/your-username/</code>.</li> <li>Adding a name is not required but recommended, it makes differentiating multiple keys a lot easier, e.g. <code>ssh-keygen -t ed25519 -C 'Computer-Home'</code>.</li> <li>The <em>private key</em> is located at <code>~/.ssh/id_ed25519</code> (without <code>.pub</code>), the <em>public key</em> is located at <code>~/.ssh/id_ed25519.pub</code>.</li></ol></blockquote> <h3 id="adding-keys-to-your-digitalocean-droplet"><a href="#adding-keys-to-your-digitalocean-droplet" class="header-anchor">#</a> Adding keys to your DigitalOcean droplet</h3> <p>To add the key</p> <ul><li>Log in to the server</li> <li>Edit <code>~/.ssh/authorized_keys</code></li> <li>Paste the public key.</li></ul> <h3 id="change-the-authentication-method"><a href="#change-the-authentication-method" class="header-anchor">#</a> Change the authentication method</h3> <p>The next step is to disable the usage of password login and move to a safer (public key based) approach.</p> <p>In <code>/etc/sshd/sshd_config</code> on the server, you'll need to change the following lines:</p> <p><strong>Enabling public key authentication:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>#PubkeyAuthentication yes
</code></pre></div><p>should become</p> <div class="language- extra-class"><pre class="language-text"><code>PubkeyAuthentication yes
</code></pre></div><p><strong>Disabling password authentication:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>#PasswordAuthentication yes
</code></pre></div><p>should become</p> <div class="language- extra-class"><pre class="language-text"><code>PasswordAuthentication no
</code></pre></div><h3 id="restart-the-ssh-daemon"><a href="#restart-the-ssh-daemon" class="header-anchor">#</a> Restart the SSH daemon</h3> <p><code>sudo service sshd restart</code></p> <p>Done!</p> <blockquote><p>Note: Always check if logging in still works with the new settings via an additional terminal window.</p></blockquote> <h1 id="_4-create-user-accounts"><a href="#_4-create-user-accounts" class="header-anchor">#</a> 4 Create User Accounts</h1> <p>DigitalOcean servers use the root account by default. That's not quite secure by design, because it does not conform to the principle of 'least privilege'.</p> <p>The best thing to do is to create an additional user which does not have root privileges by default but could gather those privileges by issuing the <code>sudo</code> command.</p> <h2 id="adding-an-additional-user"><a href="#adding-an-additional-user" class="header-anchor">#</a> Adding an additional user</h2> <p>While still being logged in to your droplet as root user, issue the following commands.</p> <ul><li><code>useradd sysadmin</code>, which will create the new user <code>sysadmin</code>.</li> <li><code>passwd sysadmin</code>, which will set up a password. This password is needed when the new user <code>sysadmin</code> invokes a <code>sudo</code> command. Use a strong password and write it down somewhere.</li> <li><code>usermod -a -G sudo sysadmin</code>, which will grant <code>sysadmin</code> the rights to issue <code>sudo</code> commands.</li> <li><code>mkdir /home/sysadmin</code>, which will make a new home directory.</li> <li><code>chown -R sysadmin /home/sysadmin</code>, which will set the correct permissions in the new directory.</li></ul> <blockquote><p>NOTE: Change the username <code>sysadmin</code> to something else if you have something different in mind, e.g. <code>devteam</code> or <code>voldermort</code>.</p></blockquote> <h2 id="adding-another-public-key"><a href="#adding-another-public-key" class="header-anchor">#</a> Adding another public key</h2> <p>Previously, you enabled Public Key Authentication (section 3.2) and it's the only way to log in to your server. This means that you should add a public key to the newly created user as well.</p> <p>Depending on your situation, you could choose to</p> <ul><li>Generate a new private / public key pair to be able to log in as this new user. This is recommended, because you still have a key pair for the <code>root</code> user as backup.</li> <li>Move the <code>root</code> key pair to this new user. This is less recommended, because this could lock you out unintentionally. But it is quite secure, as it means that practically no one could log in directly as root user.<div class="language- extra-class"><pre class="language-text"><code>mkdir /home/sysadmin/.ssh/
mv ~/.ssh/authorized_keys /home/sysadmin/.ssh/authorized_keys
chown sysadmin /home/sysadmin/.ssh/authorized_keys
</code></pre></div></li> <li><s>Use the same key as the one for the <code>root</code> user.</s> That is a <strong>terrible</strong> decision.</li></ul> <h2 id="test-the-new-user-account"><a href="#test-the-new-user-account" class="header-anchor">#</a> Test the new user account</h2> <p>Try to log in to your new user, using the new key, e.g. in a separate terminal.</p> <p><code>ssh sysadmin@&lt;server ip&gt; -p 60022</code></p> <p>Try to issue a sudo command. Quick hint: <code>sudo echo &quot;It works&quot; || echo &quot;It doesn't work&quot;</code></p> <h1 id="_5-firewall"><a href="#_5-firewall" class="header-anchor">#</a> 5 Firewall</h1> <p>For the firewall, you have two options</p> <ul><li>The quick and easy way, via the DO configuration panel</li> <li>The slow and difficult way, which provides you with more advanced features</li></ul> <h2 id="quick-easy-firewall"><a href="#quick-easy-firewall" class="header-anchor">#</a> Quick &amp; Easy Firewall</h2> <p>In your DigitalOcean panel, you could go to the networking tab and set up a firewall.</p> <h2 id="advanced-firewall"><a href="#advanced-firewall" class="header-anchor">#</a> Advanced Firewall</h2> <p>If you want a more secure and advanced approach, follow the instructions below.</p> <h3 id="step-1-reset-clear-the-current-firewall"><a href="#step-1-reset-clear-the-current-firewall" class="header-anchor">#</a> Step 1: Reset &amp; clear the current firewall</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> iptables -P INPUT ACCEPT
<span class="token function">sudo</span> iptables -F
<span class="token function">sudo</span> ip6tables -P INPUT ACCEPT
<span class="token function">sudo</span> ip6tables -F
</code></pre></div><h3 id="step-2-accept-outbound-connections"><a href="#step-2-accept-outbound-connections" class="header-anchor">#</a> Step 2: Accept outbound connections</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> iptables -A INPUT -i lo -j ACCEPT
<span class="token function">sudo</span> iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
<span class="token function">sudo</span> ip6tables -A INPUT -i lo -j ACCEPT
<span class="token function">sudo</span> ip6tables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</code></pre></div><h3 id="step-3-set-a-maximum-number-of-connections-on-specific-ports"><a href="#step-3-set-a-maximum-number-of-connections-on-specific-ports" class="header-anchor">#</a> Step 3: Set a maximum number of connections on specific ports</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> iptables -A INPUT -p tcp --syn --dport <span class="token number">80</span> -m connlimit --connlimit-above <span class="token number">4</span> -j REJECT --reject-with tcp-reset
<span class="token function">sudo</span> iptables -A INPUT -p tcp --syn --dport <span class="token number">443</span> -m connlimit --connlimit-above <span class="token number">10</span> -j REJECT --reject-with tcp-reset
<span class="token function">sudo</span> ip6tables -A INPUT -p tcp --syn --dport <span class="token number">80</span> -m connlimit --connlimit-above <span class="token number">4</span> -j REJECT --reject-with tcp-reset
<span class="token function">sudo</span> ip6tables -A INPUT -p tcp --syn --dport <span class="token number">443</span> -m connlimit --connlimit-above <span class="token number">10</span> -j REJECT --reject-with tcp-reset
</code></pre></div><h3 id="step-4-accept-the-connections-that-not-have-been-rejected"><a href="#step-4-accept-the-connections-that-not-have-been-rejected" class="header-anchor">#</a> Step 4: Accept the connections that not have been rejected</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> iptables -A INPUT -p tcp --dport <span class="token number">80</span> -j ACCEPT
<span class="token function">sudo</span> iptables -A INPUT -p tcp --dport <span class="token number">443</span> -j ACCEPT
<span class="token function">sudo</span> ip6tables -A INPUT -p tcp --dport <span class="token number">80</span> -j ACCEPT
<span class="token function">sudo</span> ip6tables -A INPUT -p tcp --dport <span class="token number">443</span> -j ACCEPT
</code></pre></div><h3 id="step-5-accept-connections-from-specific-hosts"><a href="#step-5-accept-connections-from-specific-hosts" class="header-anchor">#</a> Step 5: Accept connections from specific hosts</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> iptables -A INPUT -p tcp -s <span class="token number">123.456</span>.789.0/24 --dport <span class="token number">60022</span> -j ACCEPT
<span class="token function">sudo</span> ip6tables -A INPUT -p tcp -s <span class="token number">123.456</span>.789.0/24 --dport <span class="token number">60022</span> -j ACCEPT
</code></pre></div><h3 id="step-6-set-the-end-policy"><a href="#step-6-set-the-end-policy" class="header-anchor">#</a> Step 6: Set the end policy</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> iptables -P INPUT DROP
<span class="token function">sudo</span> iptables -P FORWARD DROP
<span class="token function">sudo</span> iptables -P OUTPUT ACCEPT
<span class="token function">sudo</span> ip6tables -P INPUT DROP
<span class="token function">sudo</span> ip6tables -P FORWARD DROP
<span class="token function">sudo</span> ip6tables -P OUTPUT ACCEPT
</code></pre></div><h3 id="step-7-making-the-configuration-permanent"><a href="#step-7-making-the-configuration-permanent" class="header-anchor">#</a> Step 7: Making the configuration permanent</h3> <p>By default, all firewall rules of <code>iptables</code> will be forgotten after a system reboot. This means that the firewall rules have to be re-initialized on each restart.</p> <p>To make it easier to save and restore firewall rules, there are two tools available on Linux: <code>iptables-save</code> for IPv4 rules and <code>ip6tables-save</code> for IPv6.</p> <h4 id="saving-the-current-firewall-rules"><a href="#saving-the-current-firewall-rules" class="header-anchor">#</a> Saving the current firewall rules</h4> <p>The first thing to do is to save the current firewall rules. The rules will be saved in the directory <code>/etc/iptables/</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/iptables
<span class="token function">sudo</span> iptables-save <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/iptables/rules.v4
<span class="token function">sudo</span> ip6tables-save <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/iptables/rules.v6
</code></pre></div><blockquote><p>Note: <code>sudo tee</code> makes it possible to directly save the output files to a directory owned by root, that is the reason why this is used here instead of regular file redirection (<code>&gt;</code>).</p></blockquote> <h4 id="automatically-reloading-at-startup"><a href="#automatically-reloading-at-startup" class="header-anchor">#</a> Automatically reloading at startup</h4> <p>It is cool that the current firewall rules are saved, but they still need to be restored at system startup somehow. This is done with a <code>systemd</code> unit, which will run the necessary stuff after network interfaces have been set up.</p> <p>Create the following file: <code>/etc/systemd/system/restore-firewall-on-boot.service</code></p> <p>Put this inside:</p> <div class="language- extra-class"><pre class="language-text"><code>[Unit]
  Description=Restore Firewall Rules
  After=network.target

[Service]
  Type=oneshot
  ExecStart=/sbin/iptables-restore /etc/iptables/rules.v4
  ExecStart=/sbin/ip6tables-restore /etc/iptables/rules.v6
  RemainAfterExit=yes

[Install]
  WantedBy=multi-user.target
</code></pre></div><p>Enable the new <code>systemd</code> unit...</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> restore-firewall-on-boot
</code></pre></div><p>Bam! The firewall rules will be restored at boot time, after the networking devices have been initialized.</p> <h1 id="_6-automatic-upgrades"><a href="#_6-automatic-upgrades" class="header-anchor">#</a> 6 Automatic upgrades</h1> <p>For production environments, it is important that a system stays secure. This could be achieved with unattended upgrades.</p> <p>On the server, execute <code>sudo apt install unattended-upgrades</code> to install this functionality.</p> <p>After installing, execute <code>sudo crontab -e</code> and add the following line:</p> <div class="language- extra-class"><pre class="language-text"><code>0 0 * * * unattended-upgrade
</code></pre></div><p>This will add a task performing automatic system updates each day at 12:00 AM.</p> <h1 id="_7-installation-of-server-applications"><a href="#_7-installation-of-server-applications" class="header-anchor">#</a> 7 Installation of server applications</h1> <p>Now we have finally installed and configured the base server, let's take a shot on the application-side.</p> <p>We're going to install Apache, PHP 7.2 and ModSecurity. But before we're going to do anything, make sure that the software repositories are up-to-date.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt</span> upgrade
</code></pre></div><h2 id="installation-of-apache"><a href="#installation-of-apache" class="header-anchor">#</a> Installation of Apache</h2> <p>Installing Apache isn't that hard...</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y apache2
</code></pre></div><p>Check if the server is accessible.</p> <h2 id="installation-of-php-7-2-php7-2-fpm"><a href="#installation-of-php-7-2-php7-2-fpm" class="header-anchor">#</a> Installation of PHP 7.2 (php7.2-fpm)</h2> <p>The below command could be used to install PHP 7.2.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y php7.2 php7.2-fpm php7.2-curl php7.2-gd php7.2-json php7.2-mysql php7.2-xml
<span class="token function">sudo</span> a2enmod proxy_fcgi setenvif
<span class="token function">sudo</span> a2enconf php7.2-fpm
<span class="token function">sudo</span> <span class="token function">service</span> apache2 restart
</code></pre></div><p>Create the file <code>/var/www/html/index.php</code> and add the following code:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?</span>
  <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre></div><p>Go to <code>http://&lt;host ip&gt;/index.php</code>, and check if PHP 7.2 was installed successfully.</p> <p>If it works, you could remove the file again.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">rm</span> /var/www/html/index.php
</code></pre></div><h2 id="installation-of-modsecurity-owasp"><a href="#installation-of-modsecurity-owasp" class="header-anchor">#</a> Installation of ModSecurity OWASP</h2> <p>ModSecurity is a Web Application Firewall that prevents malicious parties (scriptkiddies) from doing weird stuff on your server. OWASP is an abbreviation for <em>Open Web Application Security Project</em>. The OWASP-CRS (Core Rule Set) is an open source rule set for ModSecurity that has a good balance between security and usability.</p> <p>Install ModSecurity with the OWASP CRS.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libapache2-mod-security2 modsecurity-crs
<span class="token function">sudo</span> <span class="token function">cp</span> /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf
</code></pre></div><p>The next step is to actually enable ModSecurity.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">nano</span> /etc/modsecurity/modsecurity.conf
</code></pre></div><p>Change the line</p> <div class="language- extra-class"><pre class="language-text"><code>SecRuleEngine DetectionOnly
</code></pre></div><p>to</p> <div class="language- extra-class"><pre class="language-text"><code>SecRuleEngine On
</code></pre></div><p>Then, restart Apache with ModSecurity</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> a2enmod security2
<span class="token function">sudo</span> <span class="token function">service</span> apache2 restart
</code></pre></div><p>Done.</p> <blockquote><p>Note: If you are working with REST-based applications, ModSecurity could fuck up some things. So if your web application is not working, temporarily disable ModSecurity with <code>sudo a2dismod security2</code>.</p></blockquote> <h3 id="changing-the-server-signature"><a href="#changing-the-server-signature" class="header-anchor">#</a> Changing the Server Signature</h3> <p>A nice thing to do with ModSecurity is changing the server signature, so that it is impossible for others to see which server software and version is running on your machine.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">nano</span> /etc/apache2/conf-available/Security-Change-ServerSig.conf
</code></pre></div><p>Put this inside:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;IfModule mod_security2.c&gt;
    ServerTokens Full
    SecServerSignature Unix
&lt;/IfModule&gt;
</code></pre></div><p>And restart the server...</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">service</span> apache2 restart
</code></pre></div><blockquote><p>Hint: If you're using Linux, you could check the response headers from a server with the following command: <code>curl -IL example.com</code>.</p></blockquote> <h2 id="installation-of-mariadb"><a href="#installation-of-mariadb" class="header-anchor">#</a> Installation of MariaDB</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y mariadb-server
<span class="token function">sudo</span> mysql_secure_installation
</code></pre></div> <h2 id="installation-of-certbot-let-s-encrypt"><a href="#installation-of-certbot-let-s-encrypt" class="header-anchor">#</a> Installation of Certbot (Let's Encrypt)</h2> <p>To get a free Let's Encrypt Certificate, use <code>certbot</code>. Installation is done via <code>apt</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> certbot
</code></pre></div><p>For further instructions how to use Certbot, check https://certbot.eff.org/</p> <p>After Let's Encrypt is set up, it is advised to automatically renew all certificates. There are different ways to do it, but I'll use <code>cron</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> <span class="token function">crontab</span> -e
</code></pre></div><p>Add the following line to automatically check all certificates at 3:00 AM each day:</p> <div class="language- extra-class"><pre class="language-text"><code>0 3 * * * certbot renew
</code></pre></div><blockquote><p>Note: Certbot automatically renews certificates when it is needed.</p></blockquote> <h2 id="enabling-http-2-support"><a href="#enabling-http-2-support" class="header-anchor">#</a> Enabling HTTP/2 support</h2> <p>HTTP/2 makes your website faster by pipelining all requests (to a particular server) over a single TCP connection and minimizing the overhead by talking &quot;in binary&quot; format directly.</p> <p>All files (images, svgs, videos etc.) are served over a single connection, which means that there won't be an SSL negotiation delay for each single file. After all, more connections stay available to serve other people.</p> <p>Enable the HTTP/2 module in Apache.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> a2enmod http2
</code></pre></div><p>Add the following line to the SSL VirtualHost(s) that need support HTTP/2:</p> <div class="language- extra-class"><pre class="language-text"><code>Protocols h2 http/1.1
</code></pre></div><p>An example would be:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;VirtualHost *:443&gt;
  Protocols h2 http/1.1
  ServerAdmin you@your-awesome-site.com
  ServerName your-awesome-site.com
  ...
&lt;/VirtualHost&gt;
</code></pre></div><blockquote><p>Important note: HTTP/2 only works with SSL. So use them on your SSL VirtualHost(s) only, usually the ones using port <code>443</code>.</p></blockquote> <h1 id="tips-and-enhancements"><a href="#tips-and-enhancements" class="header-anchor">#</a> Tips and Enhancements</h1> <h2 id="periodic-backups"><a href="#periodic-backups" class="header-anchor">#</a> Periodic Backups</h2> <p>It is recommended to perform automatic periodic backups.</p> <h1 id="references"><a href="#references" class="header-anchor">#</a> References</h1> <p>Karunaratne, A. (2017, November 5). <em>How to enable HTTP/2 support in Apache</em>. Retrieved January 13, 2018, from https://http2.pro/doc/Apache</p> <p>Svoboda, P. (2012, May 14). <em>Laptop, SSD, tmpfs and Apache</em>. Retrieved January 13, 2018, from https://weits.blogspot.ch/2012/03/laptop-ssd-tmpfs-and-apache.html</p> <p><em>Tar archiving that takes input from a list of files</em>. (n.d.). Retrieved January 13, 2018, from https://stackoverflow.com/questions/8033857/tar-archiving-that-takes-input-from-a-list-of-files#8033898</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div> <footer tabindex="0" class="footer"><div class="grid-x"><div class="small-12 cell links"><a href="/privacy">Privacy</a><a href="/about">About</a><a href="/contact">Contact</a><a href="http://3rfoq3ia75hnxgpmtwyeyvbjbhym354tcy4ox2jaqjqhtcmd4i2mt2id.onion/">Tor</a></div> <div class="small-12 cell"><div class="footer-message"><p><i class="show-for-sr">This website was </i>
                Made with
                <svg aria-labelledby="svg-inline--fa-title-TeXMXUVnRk8j" data-prefix="fas" data-icon="heart" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon svg-inline--fa fa-heart fa-w-16"><title id="svg-inline--fa-title-TeXMXUVnRk8j">love</title><path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path></svg>
                , a lot of
                <svg aria-labelledby="svg-inline--fa-title-uk5mSTlUGMyM" data-prefix="fas" data-icon="mug-hot" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon svg-inline--fa fa-mug-hot fa-w-16"><title id="svg-inline--fa-title-uk5mSTlUGMyM">coffee</title><path fill="currentColor" d="M127.1 146.5c1.3 7.7 8 13.5 16 13.5h16.5c9.8 0 17.6-8.5 16.3-18-3.8-28.2-16.4-54.2-36.6-74.7-14.4-14.7-23.6-33.3-26.4-53.5C111.8 5.9 105 0 96.8 0H80.4C70.6 0 63 8.5 64.1 18c3.9 31.9 18 61.3 40.6 84.4 12 12.2 19.7 27.5 22.4 44.1zm112 0c1.3 7.7 8 13.5 16 13.5h16.5c9.8 0 17.6-8.5 16.3-18-3.8-28.2-16.4-54.2-36.6-74.7-14.4-14.7-23.6-33.3-26.4-53.5C223.8 5.9 217 0 208.8 0h-16.4c-9.8 0-17.5 8.5-16.3 18 3.9 31.9 18 61.3 40.6 84.4 12 12.2 19.7 27.5 22.4 44.1zM400 192H32c-17.7 0-32 14.3-32 32v192c0 53 43 96 96 96h192c53 0 96-43 96-96h16c61.8 0 112-50.2 112-112s-50.2-112-112-112zm0 160h-16v-96h16c26.5 0 48 21.5 48 48s-21.5 48-48 48z"></path></svg>
                and some
                <svg aria-labelledby="svg-inline--fa-title-qnveY11pR1wL" data-prefix="fas" data-icon="code" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon svg-inline--fa fa-code fa-w-20"><title id="svg-inline--fa-title-qnveY11pR1wL">code</title><path fill="currentColor" d="M278.9 511.5l-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2l43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6l144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg>
                by Ricardo Balk. Design available on <a href="https://behance.net/ricardobalk" target="_blank"><svg aria-labelledby="svg-inline--fa-title-ftUe3DMdEF5n" data-prefix="fab" data-icon="behance" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="icon svg-inline--fa fa-behance fa-w-18"><title id="svg-inline--fa-title-ftUe3DMdEF5n">Behance</title><path fill="currentColor" d="M232 237.2c31.8-15.2 48.4-38.2 48.4-74 0-70.6-52.6-87.8-113.3-87.8H0v354.4h171.8c64.4 0 124.9-30.9 124.9-102.9 0-44.5-21.1-77.4-64.7-89.7zM77.9 135.9H151c28.1 0 53.4 7.9 53.4 40.5 0 30.1-19.7 42.2-47.5 42.2h-79v-82.7zm83.3 233.7H77.9V272h84.9c34.3 0 56 14.3 56 50.6 0 35.8-25.9 47-57.6 47zm358.5-240.7H376V94h143.7v34.9zM576 305.2c0-75.9-44.4-139.2-124.9-139.2-78.2 0-131.3 58.8-131.3 135.8 0 79.9 50.3 134.7 131.3 134.7 61.3 0 101-27.6 120.1-86.3H509c-6.7 21.9-34.3 33.5-55.7 33.5-41.3 0-63-24.2-63-65.3h185.1c.3-4.2.6-8.7.6-13.2zM390.4 274c2.3-33.7 24.7-54.8 58.5-54.8 35.4 0 53.2 20.8 56.2 54.8H390.4z"></path></svg>.</a>
                Source code available on <a href="https://github.com/ellipticcurv3/www" target="_blank"><svg aria-labelledby="svg-inline--fa-title-Ioj450IT9OkM" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon svg-inline--fa fa-github fa-w-16"><title id="svg-inline--fa-title-Ioj450IT9OkM">GitHub</title><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>.</a></p></div></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7b7c148d.js" defer></script><script src="/assets/js/3.a804b046.js" defer></script><script src="/assets/js/18.9517a86e.js" defer></script>
  </body>
</html>
